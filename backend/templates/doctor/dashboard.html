<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Doctor Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f4f7fb;
            font-family: "Inter", sans-serif;
        }
        .sidebar {
            width: 250px;
            height: 100vh;
            background: #0056d6;
            position: fixed;
            left: 0;
            top: 0;
            padding: 20px 0;
            color: #fff;
        }
        .sidebar a {
            color: #fff;
            text-decoration: none;
            display: block;
            padding: 12px 20px;
        }
        .sidebar a:hover {
            background: rgba(255,255,255,0.15);
        }
        .main {
            margin-left: 260px;
            padding: 25px;
        }
        .patient-card {
            border-radius: 12px;
            transition: 0.2s;
        }
        .patient-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }
    </style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <h4 class="text-center mb-4">ðŸ©º Doctor Panel</h4>

    <a href="/doctor/dashboard"> Dashboard</a>
    <a href="/doctor/view-patients"> My Patients</a>
    <a href="/auth/logout"> Logout</a>
</div>

<!-- MAIN CONTENT -->
<div class="main">

    <div class="d-flex justify-content-between align-items-center">
        <h2>Welcome, Dr. {{ doctor.name }}</h2>
    </div>

    <hr>

    <!-- Stats -->
    <div class="row g-3">

        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h6>Total Patients</h6>
                <h3>{{ total_patients }}</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h6>Prescriptions</h6>
                <h3>{{ total_prescriptions }}</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h6>Lab Reports</h6>
                <h3>{{ total_reports }}</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h6>AI Logs</h6>
                <h3>{{ ai_logs_count }}</h3>
            </div>
        </div>

    </div>


    <!-- ===================== Recent Patients ===================== -->
    <div class="card shadow-sm mt-4">

        <div class="card-body">
            <input type="text" id="liveSearch" class="form-control" 
                   placeholder="ðŸ” Search patients by name, phone, etc.">
        </div>

        <div class="card-header bg-primary text-white d-flex justify-content-between">
            <h5 class="mb-0">Recent Patients</h5>
            <a href="/doctor/view-patients" class="btn btn-light btn-sm">View All</a>
        </div>

        <div class="card-body">

            {% if patients|length == 0 %}
                <p class="text-center text-muted">No patients found.</p>
            {% else %}

            <div class="row g-3">
            {% for p in patients %}

                <div class="col-md-6 col-lg-4 patient-card-item">
                    <div class="card patient-card shadow-sm">
                        <div class="card-body">

                            <h6 class="fw-bold">{{ p.first_name }} {{ p.last_name }}</h6>

                            <div class="text-muted small">
                                Last Visit:
                                {% if p.last_visit %}
                                    <span class="text-success">{{ p.last_visit }}</span>
                                {% else %}
                                    <span class="text-danger">No visits</span>
                                {% endif %}
                            </div>

                            <div class="mt-2">
                                <span class="badge bg-primary">Prescriptions: {{ p.prescription_count }}</span>
                                <span class="badge bg-info text-dark">Reports: {{ p.report_count }}</span>
                            </div>

                            <!-- VIEW + EDIT -->
                            <div class="d-flex justify-content-between mt-3">
                                <a href="/doctor/patient/{{ p.patient_id }}" 
                                   class="btn btn-outline-primary btn-sm w-100 me-1">
                                   View
                                </a>

                                <a href="/doctor/patient/{{ p.patient_id }}?edit=1" 
                                   class="btn btn-outline-secondary btn-sm w-100 ms-1">
                                   Edit
                                </a>
                            </div>

                            <!-- GENERATE + DOWNLOAD -->
                            <div class="d-flex justify-content-between mt-2">
                                <button 
                                    class="btn btn-success btn-sm w-100 me-1 generate-prescription-btn"
                                    data-open-generate="1"
                                    data-pid="{{ p.patient_id }}"
                                    data-name="{{ p.first_name }} {{ p.last_name }}"
                                    data-age="{{ p.age }}"
                                    data-phone="{{ p.phone }}">
                                     Generate
                                </button>

                                <a href="/doctor/export_pdf/{{ p.patient_id }}" 
                                   class="btn btn-dark btn-sm w-100 ms-1">
                                   â¬‡ Download
                                </a>
                            </div>

                        </div>
                    </div>
                </div>

            {% endfor %}
            </div>
            {% endif %}

        </div>
    </div>

</div>


<!-- =====================================================
     AI VOICE PRESCRIPTION MODAL
===================================================== -->
<div class="modal fade" id="aiPrescriptionModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">AI Voice Prescription</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

          <h5 id="pName" class="fw-bold"></h5>
          <div class="text-muted mb-3">
              Age: <span id="pAge"></span> â€¢ Phone: <span id="pPhone"></span>
          </div>

          <input type="hidden" id="modalPid">

          <label>ðŸŽ¤ Voice Input (Raw)</label>
          <textarea id="voiceRaw" class="form-control mb-3" rows="4"></textarea>

          <div class="d-flex gap-2 mb-3">
              <button class="btn btn-success w-50" id="startVoice">Start Voice</button>
              <button class="btn btn-danger w-50" id="stopVoice" disabled>Stop</button>
          </div>

          <button class="btn btn-warning w-100 mb-3" id="aiStructureBtn">AI Structure Prescription</button>

          <label class="fw-bold">ðŸ“„ AI Prescription Preview</label>
          <pre id="previewBox" class="p-3 bg-light border rounded" style="min-height:140px"></pre>

      </div>

      <div class="modal-footer">
          <button class="btn btn-primary" id="savePrescription">Save Prescription</button>
      </div>

    </div>
  </div>
</div>


<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Your JS -->
<script src="/static/js/doctor-prescription.js"></script>

<!-- Live Search -->
<script>
document.getElementById("liveSearch").addEventListener("input", function () {
    const q = this.value.toLowerCase().trim();

    document.querySelectorAll(".patient-card-item").forEach(card => {
        const text = card.innerText.toLowerCase();
        card.style.display = text.includes(q) ? "block" : "none";
    });
});
</script>

</body>
</html>
