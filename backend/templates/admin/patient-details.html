<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Patient Details ‚Äî Admin Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --primary:#005eea;
      --accent:#009dff;
      --card-bg:#fff;
      --muted:#666;
      --bg:#f5f8fa;
    }

    body{margin:0;font-family:Inter, sans-serif;background:var(--bg);color:#222;display:flex;min-height:100vh}

    /* Sidebar */
    .sidebar{
      width:260px;background:linear-gradient(180deg,var(--primary),var(--accent));
      color:#fff;padding:22px 0;position:fixed;left:0;top:0;height:100%;z-index:9999;transition:0.3s;display:flex;flex-direction:column;
    }
    .sidebar h2{ text-align:center;margin:0 0 22px 0;font-weight:700;font-size:20px }
    .sidebar a{ color:#fff;padding:12px 28px;display:block;text-decoration:none;font-weight:600 }
    .sidebar a.active,.sidebar a:hover{ background:rgba(255,255,255,0.12); border-left:4px solid #fff }

    .close-btn{ display:none; position:absolute; top:10px; right:15px; font-size:28px; cursor:pointer; color:#fff; }
    @media(max-width:900px){ .sidebar{ left:-280px } .sidebar.open{ left:0 } .close-btn{ display:block } }

    /* Main */
    .main{ flex:1; margin-left:260px; transition:0.3s; display:flex; flex-direction:column }
    @media(max-width:900px){ .main{ margin-left:0 } }

    .topbar{ background:#fff; padding:14px 24px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #e6eefc }
    .menu-toggle{ display:none; font-size:24px; cursor:pointer }
    @media(max-width:900px){ .menu-toggle{ display:block } }

    .content{ padding:26px; }

    /* Profile card */
    .profile-row{ display:flex; gap:18px; flex-wrap:wrap; align-items:flex-start }
    .profile-card{ background:var(--card-bg); padding:18px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06); min-width:260px; flex:0 0 320px }
    .profile-card h3{ margin:0 0 6px 0; color:var(--primary) }
    .profile-field{ color:var(--muted); font-size:14px; margin-top:8px }

    /* Summary cards */
    .cards{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:16px; align-items:stretch; flex:1; margin-left:0 }
    .card{ background:var(--card-bg); padding:16px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06); text-align:center }
    .card h4{ margin:0; color:var(--primary); font-size:13px; font-weight:700 }
    .card strong{ display:block; margin-top:8px; font-size:22px }

    /* Section blocks */
    .section{ margin-top:22px }
    .section-title{ font-size:18px; font-weight:700; color:#222; margin-bottom:12px }

    .table-box{ background:var(--card-bg); padding:12px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.04); overflow:auto }
    table{ width:100%; border-collapse:collapse; min-width:700px }
    th,td{ padding:12px 10px; border-bottom:1px solid #eef4ff; text-align:left; font-size:14px }
    th{ background:#f6fbff; color:var(--primary); font-weight:700 }

    .btn{ background:var(--primary); color:#fff; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; text-decoration:none }
    .btn.secondary{ background:#28a745 }
    .btn.ghost{ background:transparent; border:1px solid #e6eefc; color:var(--primary) }
    .btn.danger{ background:#ff4040 }

    .meta{ color:var(--muted); font-size:13px; margin-top:6px }

    /* responsive helpers */
    @media(max-width:900px){
      .profile-row{ flex-direction:column }
      .cards{ grid-template-columns:repeat(auto-fit,minmax(140px,1fr)) }
      table{ min-width:0 }
    }
  </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <span class="close-btn" onclick="toggleSidebar()">√ó</span>

  <h2>‚öôÔ∏è Admin Panel</h2>
  <a href="/admin/dashboard">üìä Admin Dashboard</a>
  <a href="/admin/manage-doctors">ü©∫ Manage Doctors</a>
  <a href="/admin/manage-patients" class="active">üë®‚Äç‚öïÔ∏è Manage Patients</a>
  <a href="/admin/audit-log">üìú Audit Log</a>
  <a href="/auth/logout">üö™ Logout</a>
</div>

<!-- Main -->
<div class="main">
  <div class="topbar">
    <span class="menu-toggle" onclick="toggleSidebar()">‚ò∞</span>
    <h2>Patient Details</h2>
    <div>
      <a class="btn" href="/admin/manage-patients">‚Üê Back to Patients</a>
    </div>
  </div>

  <div class="content">
    <!-- Header / Profile Row -->
    <div class="profile-row">
      <div class="profile-card">
        <h3>{{ patient.first_name }} {{ patient.last_name }}</h3>
        <div class="meta">Username: <strong>{{ patient.username }}</strong></div>
        <div class="profile-field">Phone: {{ patient.phone or '-' }}</div>
        <div class="profile-field">DOB: {{ patient.dob or '-' }}</div>
        <div class="profile-field">Gender: {{ patient.gender or '-' }}</div>
        <div class="profile-field">Assigned Doctor: {{ patient.doctor_name or 'Unassigned' }}</div>
        <div class="profile-field">Registered On: {{ patient.created_at or '-' }}</div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <a class="btn" href="/admin/patient/{{ patient.patient_id }}/export_pdf">Export PDF</a>
          <a class="btn ghost" href="/admin/patient/{{ patient.patient_id }}/edit">Edit</a>
          <a class="btn danger" href="/admin/patient/{{ patient.patient_id }}/delete" onclick="return confirm('Delete patient?')">Delete</a>
        </div>
      </div>

      <div style="flex:1; display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap">
        <div class="cards" style="flex:1;">
          <div class="card">
            <h4>Total Prescriptions</h4>
            <strong>{{ patient.total_prescriptions or 0 }}</strong>
            <div class="meta">Prescriptions recorded</div>
          </div>

          <div class="card">
            <h4>Lab Reports</h4>
            <strong>{{ patient.total_reports or 0 }}</strong>
            <div class="meta">Uploaded reports</div>
          </div>

          <div class="card">
            <h4>Last Visit</h4>
            <strong>{{ patient.last_visit or '-' }}</strong>
            <div class="meta">Date of last appointment</div>
          </div>

          <div class="card">
            <h4>Exported</h4>
            <strong>{{ patient.exports_count or 0 }}</strong>
            <div class="meta">Times exported</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Prescriptions -->
    <div class="section">
      <div class="section-title">Prescription History</div>
      <div class="table-box">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Doctor</th>
              <th>Diagnosis</th>
              <th>Prescription</th>
              <th>Medicines</th>
              <th>PDF</th>
            </tr>
          </thead>
          <tbody>
            {% for pres in prescriptions %}
            <tr>
              <td>{{ pres.created_at }}</td>
              <td>{{ pres.doctor_name }}</td>
              <td>{{ pres.diagnosis }}</td>
              <td style="max-width:400px;white-space:normal">{{ pres.prescription_text }}</td>
              <td>
                {% if pres.medicines %}
                  {% for m in pres.medicines %}
                    <div>{{ m.name }} ‚Äî {{ m.dosage or '' }}</div>
                  {% endfor %}
                {% else %}
                  ‚Äî
                {% endif %}
              </td>
              <td>
                <a class="btn" href="/admin/patient/{{ patient.patient_id }}/prescription/{{ pres.prescription_id }}/pdf">Download</a>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="6" style="text-align:center">No prescriptions found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Lab Reports -->
    <div class="section">
      <div class="section-title" style="margin-top:18px">Lab Reports</div>
      <div class="table-box">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Report Name</th>
              <th>Doctor</th>
              <th>File</th>
              <th>Download</th>
            </tr>
          </thead>
          <tbody>
            {% for r in reports %}
            <tr>
              <td>{{ r.upload_date }}</td>
              <td>{{ r.report_name }}</td>
              <td>{{ r.doctor_name }}</td>
              <td>{{ r.report_file }}</td>
              <td>
                <a class="btn" href="/admin/patient/{{ patient.patient_id }}/report/{{ r.report_id }}/download">Download</a>
                <a class="btn ghost" href="/static/uploads/reports/{{ r.report_file }}" target="_blank">View</a>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="5" style="text-align:center">No lab reports found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Audit log for this patient -->
    <div class="section">
      <div class="section-title" style="margin-top:18px">Activity / Audit Log (Patient)</div>
      <div class="table-box">
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>User Role</th>
              <th>User ID</th>
              <th>Action</th>
              <th>IP</th>
            </tr>
          </thead>
          <tbody>
            {% for a in patient_audit %}
            <tr>
              <td>{{ a.timestamp }}</td>
              <td>{{ a.user_role }}</td>
              <td>{{ a.user_id }}</td>
              <td>{{ a.action }}</td>
              <td>{{ a.ip_address or '-' }}</td>
            </tr>
            {% else %}
            <tr><td colspan="5" style="text-align:center">No audit entries for this patient.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
}
</script>

</body>
</html>
